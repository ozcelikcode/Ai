{% extends "admin/base.html" %}

{% block page_title %}Kategoriler{% endblock %}
{% block page_description %}Blog kategorilerinizi yönetin{% endblock %}

{% block content %}
<!-- Mesajlar -->
{% if request.query_params.get('error') %}
<div class="mb-6">
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <strong class="font-bold">Hata!</strong>
        <span class="block sm:inline">
            {% set error_code = request.query_params.get('error') %}
            {% if error_code == 'last_default' %}
                En az bir varsayılan kategori olmalıdır. Önce başka bir kategoriyi varsayılan yapın.
            {% elif error_code == 'delete_default' %}
                Varsayılan kategori silinemez. Önce başka bir kategoriyi varsayılan yapın.
            {% elif error_code == 'invalid_replacement' %}
                Geçersiz yedek kategori seçildi. Lütfen tekrar deneyin.
            {% else %}
                Bilinmeyen bir hata oluştu.
            {% endif %}
        </span>
        <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
            <svg onclick="this.parentElement.parentElement.parentElement.style.display='none'" class="fill-current h-6 w-6 text-red-500 cursor-pointer" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                <title>Kapat</title>
                <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
            </svg>
        </span>
    </div>
</div>
{% endif %}

{% if request.query_params.get('success') %}
<div class="mb-6">
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
        <strong class="font-bold">Başarılı!</strong>
        <span class="block sm:inline">
            {% set success_code = request.query_params.get('success') %}
            {% if success_code == 'deleted' %}
                Kategori başarıyla silindi ve içerikler yeni kategoriye aktarıldı.
            {% elif success_code == 'created' %}
                Kategori başarıyla oluşturuldu.
            {% elif success_code == 'updated' %}
                Kategori başarıyla güncellendi.
            {% else %}
                İşlem başarıyla tamamlandı.
            {% endif %}
        </span>
        <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
            <svg onclick="this.parentElement.parentElement.parentElement.style.display='none'" class="fill-current h-6 w-6 text-green-500 cursor-pointer" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                <title>Kapat</title>
                <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
            </svg>
        </span>
    </div>
</div>
{% endif %}

<!-- Başlık ve Yeni Kategori Butonu -->
<div class="flex items-center justify-between mb-6">
    <h3 class="text-lg font-semibold text-brown-900">Tüm Kategoriler</h3>
    <button onclick="openNewCategoryModal()" class="bg-brown-600 text-white px-4 py-2 rounded-lg hover:bg-brown-700 transition-smooth">
        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
        Yeni Kategori
    </button>
</div>

<!-- Kategoriler Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for category in categories %}
    <div class="bg-white rounded-xl shadow-lg p-6 hover-lift transition-smooth">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 {% if category.is_default %}bg-green-600{% else %}bg-brown-600{% endif %} rounded-lg flex items-center justify-center">
                <i data-lucide="{% if category.is_default %}star{% else %}folder{% endif %}" class="w-6 h-6 text-white"></i>
            </div>
            <div class="flex space-x-2">
                <button onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.description or '' }}', {{ 'true' if category.is_default else 'false' }})" 
                        class="text-brown-600 hover:text-brown-800 transition-smooth">
                    <i data-lucide="edit" class="w-4 h-4"></i>
                </button>
                {% if category.is_default %}
                <button onclick="showDefaultCategoryWarning()" 
                        class="text-gray-400 cursor-not-allowed transition-smooth" 
                        title="Varsayılan kategori silinemez">
                    <i data-lucide="shield" class="w-4 h-4"></i>
                </button>
                {% else %}
                <button onclick="deleteCategory({{ category.id }})" 
                        class="text-red-600 hover:text-red-800 transition-smooth">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
                {% endif %}
            </div>
        </div>
        
        <div class="mb-3">
            <div class="flex items-center space-x-2 mb-1">
                <h3 class="text-lg font-semibold text-brown-900">{{ category.name }}</h3>
                {% if category.is_default %}
                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Varsayılan</span>
                {% endif %}
            </div>
            <p class="text-brown-600 text-sm">{{ category.description or 'Açıklama bulunmuyor' }}</p>
        </div>
        <p class="text-xs text-brown-500">{{ category.posts|length }} yazı</p>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12">
        <div class="w-16 h-16 bg-brown-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="folder" class="w-8 h-8 text-brown-600"></i>
        </div>
        <h3 class="text-lg font-semibold text-brown-900 mb-2">Henüz kategori yok</h3>
        <p class="text-brown-600 mb-4">İlk kategorinizi oluşturun</p>
        <button onclick="openNewCategoryModal()" class="bg-brown-600 text-white px-4 py-2 rounded-lg hover:bg-brown-700 transition-smooth">
            Kategori Ekle
        </button>
    </div>
    {% endfor %}
</div>

<!-- Kategori Modal -->
<div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-96">
        <h3 id="modalTitle" class="text-lg font-semibold text-brown-900 mb-4">Yeni Kategori</h3>
        
        <form id="categoryForm" method="POST">
            <div class="mb-4">
                <label class="block text-brown-700 font-medium mb-2">Kategori Adı</label>
                <input type="text" id="categoryName" name="name" required 
                       class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
            </div>
            
            <div class="mb-4">
                <label class="block text-brown-700 font-medium mb-2">Açıklama</label>
                <textarea id="categoryDescription" name="description" rows="3"
                          class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent"></textarea>
            </div>
            
            <div class="mb-6">
                <label class="flex items-center">
                    <input type="checkbox" id="categoryDefault" name="is_default" 
                           class="rounded border-brown-300 text-brown-600 focus:ring-brown-500">
                    <span class="ml-2 text-brown-700 font-medium">Varsayılan kategori olarak işaretle</span>
                </label>
                <p class="text-xs text-brown-500 mt-1">Sadece bir kategori varsayılan olabilir</p>
            </div>
            
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-brown-600 text-white py-2 rounded-lg hover:bg-brown-700 transition-smooth">
                    Kaydet
                </button>
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-smooth">
                    İptal
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Kategori Silme Modal -->
<div id="deleteCategoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-96">
        <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-brown-900">Kategori Sil</h3>
        </div>
        
        <p class="text-brown-600 mb-4">Bu kategorideki yazılar hangi kategori ile değiştirilsin?</p>
        
        <form id="deleteCategoryForm" method="POST">
            <div class="mb-6">
                <label class="block text-brown-700 font-medium mb-2">Yeni Kategori Seçin</label>
                <select id="replacementCategory" name="replacement_category" required
                        class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                    <option value="">Kategori seçin...</option>
                </select>
            </div>
            
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-smooth">
                    Kategoriyi Sil
                </button>
                <button type="button" onclick="closeDeleteModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-smooth">
                    İptal
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let editingCategoryId = null;

function openNewCategoryModal() {
    editingCategoryId = null;
    document.getElementById('modalTitle').textContent = 'Yeni Kategori';
    document.getElementById('categoryForm').action = '/admin/categories/new';
    document.getElementById('categoryName').value = '';
    document.getElementById('categoryDescription').value = '';
    document.getElementById('categoryDefault').checked = false;
    document.getElementById('categoryModal').classList.remove('hidden');
}

function editCategory(id, name, description, isDefault) {
    editingCategoryId = id;
    document.getElementById('modalTitle').textContent = 'Kategori Düzenle';
    document.getElementById('categoryForm').action = `/admin/categories/${id}/edit`;
    document.getElementById('categoryName').value = name;
    document.getElementById('categoryDescription').value = description;
    document.getElementById('categoryDefault').checked = isDefault;
    document.getElementById('categoryModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('categoryModal').classList.add('hidden');
}

async function deleteCategory(categoryId) {
    try {
        // Get available replacement categories
        const response = await fetch('/admin/api/categories');
        const data = await response.json();
        
        // Filter out the category being deleted
        const availableCategories = data.categories.filter(cat => cat.id !== categoryId);
        
        if (availableCategories.length === 0) {
            alert('Bu kategoriyi silemezsiniz çünkü başka kategori bulunmuyor.');
            return;
        }
        
        // Populate replacement category select
        const select = document.getElementById('replacementCategory');
        select.innerHTML = '<option value="">Kategori seçin...</option>';
        
        availableCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        });
        
        // Set form action
        document.getElementById('deleteCategoryForm').action = `/admin/categories/${categoryId}/delete`;
        
        // Show modal
        document.getElementById('deleteCategoryModal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Kategori silme hatası:', error);
        alert('Kategori silinirken bir hata oluştu.');
    }
}

function closeDeleteModal() {
    document.getElementById('deleteCategoryModal').classList.add('hidden');
}

function showDefaultCategoryWarning() {
    alert('Varsayılan kategori silinemez. Önce başka bir kategoriyi varsayılan yapın.');
}

// Modal dışına tıklayınca kapat
document.getElementById('categoryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('deleteCategoryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>
{% endblock %}