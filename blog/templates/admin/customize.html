{% extends "admin/base.html" %}

{% block page_title %}Site Özelleştirme{% endblock %}
{% block page_description %}Sitenizin görünümünü ve footer ayarlarını yönetin{% endblock %}

{% block content %}
{% if request.query_params.get('success') %}
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6">
    <i data-lucide="check-circle" class="w-5 h-5 inline mr-2"></i>
    Site özelleştirme ayarları başarıyla kaydedildi!
</div>
{% endif %}

<form method="POST" action="/admin/customize/save" enctype="multipart/form-data">
    <div class="space-y-8">
        
        <!-- Logo Özelleştirme -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-brown-900 mb-4 flex items-center">
                <i data-lucide="image" class="w-5 h-5 mr-2"></i>
                Logo Özelleştirme
            </h3>
            
            <div class="space-y-6">
                <!-- Logo Type Selection -->
                <div>
                    <label class="block text-brown-700 font-medium mb-3">Logo Türü Seçin</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="logo_type" value="text" 
                                   {% if not settings or not settings.logo_type or settings.logo_type == 'text' %}checked{% endif %}
                                   class="sr-only peer">
                            <div class="p-4 border-2 border-cream-300 rounded-xl peer-checked:border-brown-500 peer-checked:bg-brown-50 hover:bg-cream-50 transition-smooth text-center">
                                <i data-lucide="type" class="w-8 h-8 mx-auto mb-2 text-brown-600"></i>
                                <div class="font-medium text-brown-900">Sadece Metin</div>
                                <div class="text-sm text-brown-600">Sadece site başlığı</div>
                            </div>
                        </label>
                        
                        <label class="relative cursor-pointer">
                            <input type="radio" name="logo_type" value="image" 
                                   {% if settings and settings.logo_type == 'image' %}checked{% endif %}
                                   class="sr-only peer">
                            <div class="p-4 border-2 border-cream-300 rounded-xl peer-checked:border-brown-500 peer-checked:bg-brown-50 hover:bg-cream-50 transition-smooth text-center">
                                <i data-lucide="image" class="w-8 h-8 mx-auto mb-2 text-brown-600"></i>
                                <div class="font-medium text-brown-900">Sadece Resim</div>
                                <div class="text-sm text-brown-600">Logo resmi</div>
                            </div>
                        </label>
                        
                        <label class="relative cursor-pointer">
                            <input type="radio" name="logo_type" value="icon_text" 
                                   {% if settings and settings.logo_type == 'icon_text' %}checked{% endif %}
                                   class="sr-only peer">
                            <div class="p-4 border-2 border-cream-300 rounded-xl peer-checked:border-brown-500 peer-checked:bg-brown-50 hover:bg-cream-50 transition-smooth text-center">
                                <i data-lucide="layout" class="w-8 h-8 mx-auto mb-2 text-brown-600"></i>
                                <div class="font-medium text-brown-900">İkon + Metin</div>
                                <div class="text-sm text-brown-600">İkon ve başlık</div>
                            </div>
                        </label>
                        
                        <label class="relative cursor-pointer">
                            <input type="radio" name="logo_type" value="icon" 
                                   {% if settings and settings.logo_type == 'icon' %}checked{% endif %}
                                   class="sr-only peer">
                            <div class="p-4 border-2 border-cream-300 rounded-xl peer-checked:border-brown-500 peer-checked:bg-brown-50 hover:bg-cream-50 transition-smooth text-center">
                                <i data-lucide="star" class="w-8 h-8 mx-auto mb-2 text-brown-600"></i>
                                <div class="font-medium text-brown-900">Sadece İkon</div>
                                <div class="text-sm text-brown-600">Sadece ikon</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Icon Selection -->
                <div id="logo-icon-field" class="hidden">
                    <label class="block text-brown-700 font-medium mb-2">Logo İkon</label>
                    <div class="flex space-x-4">
                        <input type="text" name="logo_icon" 
                               value="{{ settings.logo_icon if settings else '' }}" 
                               placeholder="home, star, zap, heart, etc."
                               class="flex-1 px-3 py-3 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                        <div class="flex items-center px-4 py-3 bg-cream-50 rounded-lg border">
                            <span class="text-sm text-brown-600 mr-2">Önizleme:</span>
                            <i id="icon-preview" data-lucide="{{ settings.logo_icon if settings and settings.logo_icon else 'home' }}" class="w-6 h-6 text-brown-600"></i>
                        </div>
                    </div>
                    <p class="text-sm text-brown-600 mt-2">
                        <a href="https://lucide.dev/icons/" target="_blank" class="text-brown-700 hover:underline">
                            Lucide Icons kataloğundan ikon adı seçin →
                        </a>
                    </p>
                </div>
                
                <!-- Image Selection -->
                <div id="logo-image-field" class="hidden">
                    <label class="block text-brown-700 font-medium mb-2">Logo Resmi</label>
                    
                    <!-- Current logo preview -->
                    {% if settings and settings.site_logo %}
                    <div class="mb-4 p-4 bg-cream-50 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <img src="{{ settings.site_logo }}" alt="Current Logo" class="w-16 h-16 object-contain">
                            <div>
                                <p class="font-medium text-brown-900">Mevcut Logo</p>
                                <p class="text-sm text-brown-600">{{ settings.site_logo }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-brown-700 mb-2">Dosya Yükle</label>
                            <input type="file" name="logo_file" accept="image/*" 
                                   class="w-full px-3 py-3 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                        </div>
                        
                        <div class="text-center text-brown-500">veya</div>
                        
                        <div>
                            <label class="block text-sm font-medium text-brown-700 mb-2">Logo URL'i</label>
                            <input type="url" name="site_logo" 
                                   value="{% if settings and settings.site_logo %}{{ settings.site_logo }}{% endif %}" 
                                   placeholder="https://example.com/logo.png"
                                   class="w-full px-3 py-3 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">
                        </div>
                        
                        <div class="text-center text-brown-500">veya</div>
                        
                        <div>
                            <button type="button" onclick="openMediaGallery('logo')" 
                                    class="w-full px-4 py-3 bg-cream-100 text-brown-700 rounded-lg hover:bg-cream-200 transition-smooth flex items-center justify-center">
                                <i data-lucide="folder" class="w-5 h-5 mr-2"></i>
                                Medya Galerisinden Seç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Özelleştirme -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-brown-900 mb-4 flex items-center">
                <i data-lucide="layout" class="w-5 h-5 mr-2"></i>
                Footer Özelleştirme
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-brown-700 font-medium mb-2">Footer İçeriği</label>
                    <textarea name="footer_content" rows="8" 
                              placeholder="Footer alanında görünecek içerik. HTML etiketleri kullanabilirsiniz."
                              class="w-full px-3 py-3 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-transparent">{% if settings and settings.footer_content %}{{ settings.footer_content }}{% endif %}</textarea>
                    <div class="flex items-start mt-2 text-sm">
                        <i data-lucide="info" class="w-4 h-4 text-blue-500 mr-2 mt-0.5 flex-shrink-0"></i>
                        <div class="text-brown-600">
                            <p class="mb-1">HTML etiketleri kullanabilirsiniz. Örnek içerik:</p>
                            <code class="text-xs bg-cream-100 px-2 py-1 rounded">
                                &lt;p&gt;© 2024 Site Adı. Tüm hakları saklıdır.&lt;/p&gt;<br>
                                &lt;div class="flex space-x-4"&gt;<br>
                                &nbsp;&nbsp;&lt;a href="/about"&gt;Hakkımızda&lt;/a&gt;<br>
                                &nbsp;&nbsp;&lt;a href="/contact"&gt;İletişim&lt;/a&gt;<br>
                                &lt;/div&gt;
                            </code>
                        </div>
                    </div>
                </div>
                
                <!-- Footer preview -->
                <div class="border-t border-cream-200 pt-4">
                    <label class="block text-brown-700 font-medium mb-2">Önizleme</label>
                    <div class="bg-brown-900 text-cream-100 p-6 rounded-lg">
                        <div id="footer-preview">
                            {% if settings and settings.footer_content %}
                                {{ settings.footer_content|safe }}
                            {% else %}
                                <p class="text-center text-cream-300">Footer içeriği burada görünecek...</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kaydet Butonu -->
        <div class="flex justify-end space-x-4">
            <a href="/admin/settings" 
               class="px-6 py-3 border border-brown-300 text-brown-700 rounded-lg hover:bg-brown-50 transition-smooth">
                <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
                Genel Ayarlara Dön
            </a>
            <button type="submit" 
                    class="bg-brown-600 text-white px-6 py-3 rounded-lg hover:bg-brown-700 transition-smooth">
                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                Değişiklikleri Kaydet
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Logo type selection handler
document.addEventListener('DOMContentLoaded', function() {
    const logoTypeRadios = document.querySelectorAll('input[name="logo_type"]');
    const logoIconField = document.getElementById('logo-icon-field');
    const logoImageField = document.getElementById('logo-image-field');
    const iconInput = document.querySelector('input[name="logo_icon"]');
    const iconPreview = document.getElementById('icon-preview');
    const footerTextarea = document.querySelector('textarea[name="footer_content"]');
    const footerPreview = document.getElementById('footer-preview');
    
    function toggleLogoFields() {
        const selectedType = document.querySelector('input[name="logo_type"]:checked').value;
        
        logoIconField.classList.add('hidden');
        logoImageField.classList.add('hidden');
        
        if (selectedType === 'icon' || selectedType === 'icon_text') {
            logoIconField.classList.remove('hidden');
        }
        
        if (selectedType === 'image' || selectedType === 'icon_text') {
            logoImageField.classList.remove('hidden');
        }
    }
    
    logoTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleLogoFields);
    });
    
    // Icon preview update
    if (iconInput && iconPreview) {
        iconInput.addEventListener('input', function() {
            const iconName = this.value.trim() || 'home';
            iconPreview.setAttribute('data-lucide', iconName);
            lucide.createIcons();
        });
    }
    
    // Footer content preview
    if (footerTextarea && footerPreview) {
        footerTextarea.addEventListener('input', function() {
            const content = this.value.trim();
            if (content) {
                footerPreview.innerHTML = content;
            } else {
                footerPreview.innerHTML = '<p class="text-center text-cream-300">Footer içeriği burada görünecek...</p>';
            }
        });
    }
    
    toggleLogoFields();
});

// Media gallery modal functions
let mediaGalleryModal = null;
let mediaGalleryTarget = null;

function openMediaGallery(target) {
    mediaGalleryTarget = target;
    
    if (!mediaGalleryModal) {
        createMediaGalleryModal();
    }
    
    loadMediaFiles();
    mediaGalleryModal.classList.remove('hidden');
}

function createMediaGalleryModal() {
    const modalHtml = `
        <div id="media-gallery-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Medya Galerisi - Logo Seç</h3>
                    <button onclick="closeMediaGallery()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="media-grid" class="grid grid-cols-4 gap-4">
                    <div class="text-center py-8">
                        <i data-lucide="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                        <p>Medya dosyaları yükleniyor...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    mediaGalleryModal = document.getElementById('media-gallery-modal');
}

function closeMediaGallery() {
    if (mediaGalleryModal) {
        mediaGalleryModal.classList.add('hidden');
    }
}

async function loadMediaFiles() {
    try {
        const response = await fetch('/admin/api/media');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const mediaGrid = document.getElementById('media-grid');
        
        if (!mediaGrid) {
            console.error('Media grid element not found');
            return;
        }
        
        mediaGrid.innerHTML = '';
        
        if (data.success && data.media && data.media.length > 0) {
            data.media.forEach(media => {
                if (media.mime_type && media.mime_type.startsWith('image/')) {
                    const mediaItem = document.createElement('div');
                    mediaItem.className = 'cursor-pointer border-2 border-transparent hover:border-brown-500 rounded-lg overflow-hidden transition-smooth';
                    mediaItem.onclick = () => selectMedia(media.file_path);
                    
                    mediaItem.innerHTML = `
                        <img src="${media.file_path}" alt="${media.alt_text || media.original_name || 'Media'}" 
                             class="w-full h-24 object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-24 bg-gray-200 flex items-center justify-center" style="display:none;">
                            <i data-lucide="image-off" class="w-8 h-8 text-gray-500"></i>
                        </div>
                        <p class="p-2 text-xs text-gray-600 truncate">${media.original_name || 'Untitled'}</p>
                    `;
                    
                    mediaGrid.appendChild(mediaItem);
                }
            });
        } else {
            mediaGrid.innerHTML = '<div class="col-span-4 text-center py-8 text-brown-600"><i data-lucide="image-off" class="w-12 h-12 mx-auto mb-2"></i><p>Henüz medya dosyası yok</p></div>';
        }
        
        // Reinitialize Lucide icons
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Media yüklenirken hata:', error);
        const mediaGrid = document.getElementById('media-grid');
        if (mediaGrid) {
            mediaGrid.innerHTML = '<div class="col-span-4 text-center py-8 text-red-600"><i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i><p>Media dosyaları yüklenemedi</p></div>';
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
    }
}

function selectMedia(filePath) {
    if (mediaGalleryTarget === 'logo') {
        document.querySelector('input[name="site_logo"]').value = filePath;
    }
    
    closeMediaGallery();
}
</script>
{% endblock %}