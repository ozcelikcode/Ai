{% extends "admin/base.html" %}

{% block page_title %}{% if post %}Yazı Düzenle{% else %}Yeni Yazı{% endif %}{% endblock %}
{% block page_description %}{% if post %}{{ post.title }} yazısını düzenleyin{% else %}Yeni blog yazısı oluşturun{% endif %}{% endblock %}

{% block extra_head %}
<!-- Jodit Editor CSS -->
<link rel="stylesheet" href="https://unpkg.com/jodit@3.24.5/build/jodit.min.css"/>
<style>
.jodit-container {
    border-radius: 8px;
    border-color: #dbc5b7;
}
.jodit-toolbar {
    background: #f7f3f0;
    border-color: #dbc5b7;
}
.jodit-workplace {
    background: #fff;
}
.ai-suggestion { 
    background: linear-gradient(135deg, #f7f3f0 0%, #ede4db 100%);
    border: 1px solid #dbc5b7;
}
.slug-preview {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    background: #f7f3f0;
    border: 1px solid #dbc5b7;
    color: #7b4030;
}
.jodit-wysiwyg h1, .jodit-wysiwyg h2, .jodit-wysiwyg h3, .jodit-wysiwyg h4 {
    margin: 1.5em 0 1em 0;
    font-weight: bold;
    line-height: 1.3;
}
.jodit-wysiwyg h1 { font-size: 2em; color: #2c1810; }
.jodit-wysiwyg h2 { font-size: 1.5em; color: #3d2317; }
.jodit-wysiwyg h3 { font-size: 1.25em; color: #4d2b1d; }
.jodit-wysiwyg h4 { font-size: 1.1em; color: #5d3323; }
.jodit-wysiwyg p {
    margin: 1em 0;
    line-height: 1.6;
}
.jodit-wysiwyg ul, .jodit-wysiwyg ol {
    margin: 1em 0;
    padding-left: 2em;
}
.jodit-wysiwyg li {
    margin: 0.5em 0;
    line-height: 1.5;
}
</style>
{% endblock %}

{% block content %}
<!-- Yazı Formu -->
<form method="POST" action="{% if post %}/admin/posts/{{ post.id }}/edit{% else %}/admin/posts/new{% endif %}" enctype="multipart/form-data" class="space-y-6" onsubmit="syncEditorContent()">
    
    <!-- Üst Kısım: Başlık ve İşlem Butonları -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <a href="/admin/posts" class="text-brown-600 hover:text-brown-800 transition-smooth">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h2 class="text-xl font-semibold text-brown-900">
                    {% if post %}Yazı Düzenle{% else %}Yeni Yazı Oluştur{% endif %}
                </h2>
            </div>
            
            <div class="flex items-center space-x-3">
                <!-- AI Yardım Butonu -->
                <a href="/admin/ai-assistant" target="_blank" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-smooth flex items-center">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                    AI Yardımcı
                </a>
                
                <!-- Hızlı AI Yardım -->
                <button type="button" id="ai-help-btn" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200 transition-smooth flex items-center">
                    <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                    Hızlı AI
                </button>
                
                <!-- Taslak Kaydet -->
                <button type="button" onclick="saveDraft()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-smooth">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                    Taslak Kaydet
                </button>
                
                <!-- Yayınla -->
                <button type="submit" name="action" value="publish" class="bg-brown-600 text-white px-6 py-2 rounded-lg hover:bg-brown-700 transition-smooth">
                    <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                    {% if post and post.is_published %}Güncelle{% else %}Yayınla{% endif %}
                </button>
            </div>
        </div>
        
        <!-- Başlık -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-brown-700 mb-2">Yazı Başlığı</label>
            <input type="text" name="title" id="title" required
                   value="{{ post.title if post else '' }}"
                   class="w-full px-4 py-3 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-brown-500 text-lg"
                   placeholder="Harika bir başlık yazın...">
        </div>
        
        <!-- Slug Önizleme -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-brown-700 mb-2">URL Slug</label>
            <div class="flex items-center space-x-2">
                <span class="text-brown-600 text-sm">http://localhost:8000/</span>
                <span class="text-brown-600 text-sm" id="category-slug">kategori/</span>
                <input type="text" name="slug" id="slug"
                       value="{{ post.slug if post else '' }}"
                       class="flex-1 px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-brown-500 slug-preview"
                       placeholder="url-slug-otomatik-olusur">
            </div>
            <p class="text-xs text-brown-500 mt-1">Başlık yazıldıkça otomatik oluşur, düzenleyebilirsiniz</p>
        </div>
        
        <!-- Kategori ve Etiketler -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-brown-700 mb-2">Kategori</label>
                <select name="category_id" class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-brown-500">
                    <option value="">Kategori Seçin</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if post and post.category_id == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-brown-700 mb-2">Etiketler</label>
                <input type="text" name="tags" id="tags"
                       value="{% if post and post.tags %}{% for tag in post.tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
                       class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-brown-500"
                       placeholder="etiket1, etiket2, etiket3">
                <p class="text-xs text-brown-500 mt-1">Virgülle ayırarak yazın</p>
            </div>
        </div>
    </div>
    
    <!-- İçerik Editörü -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-brown-700">Yazı İçeriği</label>
                <div class="flex items-center space-x-2 text-sm text-brown-600">
                    <span id="word-count">0 kelime</span>
                    <span>•</span>
                    <span id="read-time">0 dk okuma</span>
                </div>
            </div>
            <textarea name="content" id="content" rows="20"
                      class="w-full px-4 py-3 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-brown-500"
                      placeholder="Muhteşem içeriğinizi buraya yazın...">{{ post.content if post else '' }}</textarea>
        </div>
    </div>
    
    <!-- Ek Ayarlar -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-brown-900 mb-4">Ek Ayarlar</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Sol Kolon -->
            <div class="space-y-4">
                <!-- Kapak Resmi -->
                <div>
                    <label class="block text-sm font-medium text-brown-700 mb-2">Kapak Resmi</label>
                    <div class="flex items-center space-x-3">
                        <input type="file" accept="image/*" class="hidden" id="featured-image-input">
                        <button type="button" onclick="document.getElementById('featured-image-input').click()" 
                                class="flex items-center px-4 py-2 border border-cream-300 rounded-lg hover:bg-cream-50 transition-smooth">
                            <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                            Resim Yükle
                        </button>
                        <button type="button" onclick="openMediaModal()" 
                                class="flex items-center px-4 py-2 border border-cream-300 rounded-lg hover:bg-cream-50 transition-smooth">
                            <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                            Galeriden Seç
                        </button>
                    </div>
                    
                    <!-- Featured Image Preview -->
                    <div id="featured-image-preview" class="mt-3 hidden">
                        <div class="relative inline-block">
                            <img id="featured-image-img" src="" alt="Kapak resmi" class="w-40 h-24 object-cover rounded-lg border border-cream-300">
                            <button type="button" onclick="removeFeaturedImage()" 
                                    class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-smooth">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <p class="text-xs text-brown-500 mt-1">Yüklenen kapak resmi</p>
                    </div>
                    
                    <!-- Hidden input for featured image URL -->
                    <input type="hidden" name="featured_image" id="featured-image-url" value="{% if post and post.featured_image %}{{ post.featured_image }}{% endif %}">
                    
                    {% if post and post.featured_image %}
                    <script>
                        // Show existing featured image on load
                        document.addEventListener('DOMContentLoaded', function() {
                            showFeaturedImagePreview('{{ post.featured_image }}');
                        });
                    </script>
                    {% endif %}
                </div>
                
                <!-- Meta Description -->
                <div>
                    <label class="block text-sm font-medium text-brown-700 mb-2">Meta Açıklama (SEO)</label>
                    <textarea name="meta_description" rows="3"
                              class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-brown-500"
                              placeholder="Arama motorları için kısa açıklama...">{{ post.meta_description if post else '' }}</textarea>
                    <p class="text-xs text-brown-500 mt-1">İdeal uzunluk: 150-160 karakter</p>
                </div>
            </div>
            
            <!-- Sağ Kolon -->
            <div class="space-y-4">
                <!-- Yayın Tarihi -->
                <div>
                    <label class="block text-sm font-medium text-brown-700 mb-2">Yayın Tarihi</label>
                    <input type="datetime-local" name="published_at"
                           value="{{ post.published_at.strftime('%Y-%m-%dT%H:%M') if post and post.published_at else '' }}"
                           class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-brown-500 focus:border-brown-500">
                    <p class="text-xs text-brown-500 mt-1">Boş bırakılırsa şu anki zaman kullanılır</p>
                </div>
                
                <!-- Seçenekler -->
                <div class="space-y-3">
                    <label class="flex items-center">
                        <input type="checkbox" name="show_updated_date" 
                               {% if not post or post.show_updated_date %}checked{% endif %}
                               class="rounded border-brown-300 text-brown-600 focus:ring-brown-500">
                        <span class="ml-2 text-sm text-brown-700">Güncellenme tarihini göster</span>
                    </label>
                    
                    <label class="flex items-center">
                        <input type="checkbox" name="allow_comments" 
                               {% if not post or post.allow_comments %}checked{% endif %}
                               class="rounded border-brown-300 text-brown-600 focus:ring-brown-500">
                        <span class="ml-2 text-sm text-brown-700">Yorumlara izin ver</span>
                    </label>
                    
                    <label class="flex items-center">
                        <input type="checkbox" name="is_featured" 
                               {% if post and post.is_featured %}checked{% endif %}
                               class="rounded border-brown-300 text-brown-600 focus:ring-brown-500">
                        <span class="ml-2 text-sm text-brown-700">Öne çıkarılmış yazı</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden Fields -->
    <input type="hidden" name="author_id" value="{{ admin_user.id }}">
</form>

<!-- AI Yardım Modal -->
<div id="ai-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-brown-900 flex items-center">
                <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-purple-600"></i>
                AI Yazı Asistanı
            </h3>
            <button id="close-ai-modal" class="text-brown-600 hover:text-brown-800">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-brown-700 mb-2">Ne hakkında yazı istiyorsunuz?</label>
                <input type="text" id="ai-topic" 
                       class="w-full px-4 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                       placeholder="Örn: Python programlama, yapay zeka, web tasarım...">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-brown-700 mb-2">Yazı Uzunluğu</label>
                    <select id="ai-length" class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="short">Kısa (300-500 kelime)</option>
                        <option value="medium" selected>Orta (500-800 kelime)</option>
                        <option value="long">Uzun (800+ kelime)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-brown-700 mb-2">Yazı Tonu</label>
                    <select id="ai-tone" class="w-full px-3 py-2 border border-cream-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="professional" selected>Profesyonel</option>
                        <option value="casual">Samimi</option>
                        <option value="technical">Teknik</option>
                        <option value="educational">Eğitici</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button type="button" onclick="generateWithAI('title')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-smooth">
                    Sadece Başlık Üret
                </button>
                <button type="button" onclick="generateWithAI('content')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-smooth">
                    Sadece İçerik Üret
                </button>
                <button type="button" onclick="generateWithAI('full')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-smooth">
                    Tam Yazı Üret (Meta+Etiket)
                </button>
                <button type="button" onclick="generateWithAI('seo')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-smooth">
                    <i data-lucide="search" class="w-4 h-4 mr-1 inline"></i>
                    SEO Otomatik Doldur
                </button>
            </div>
        </div>
        
        <div id="ai-result" class="hidden mt-6 p-4 ai-suggestion rounded-lg">
            <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium text-brown-900">AI Önerisi:</h4>
                <button type="button" onclick="applyAISuggestion()" class="text-purple-600 hover:text-purple-800 text-sm">
                    Uygula
                </button>
            </div>
            <div id="ai-content" class="text-brown-700 prose prose-sm max-w-none"></div>
        </div>
        
        <div id="ai-loading" class="hidden mt-6 text-center">
            <div class="inline-flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-3"></div>
                <span class="text-brown-600">AI içerik oluşturuyor, lütfen bekleyin...</span>
            </div>
        </div>
    </div>
</div>

<!-- Medya Modal (Kapak resmi seçimi için) -->
<div id="media-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-brown-900">Medya Galerisi</h3>
            <button id="close-media-modal" class="text-brown-600 hover:text-brown-800">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div id="media-grid" class="grid grid-cols-4 md:grid-cols-6 gap-4">
            <!-- Medya dosyaları buraya yüklenecek -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Slug otomatik oluşturma
document.getElementById('title').addEventListener('input', function() {
    const title = this.value;
    const slug = title
        .toLowerCase()
        .replace(/ğ/g, 'g')
        .replace(/ü/g, 'u')
        .replace(/ş/g, 's')
        .replace(/ı/g, 'i')
        .replace(/ö/g, 'o')
        .replace(/ç/g, 'c')
        .replace(/[^a-z0-9]/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
    
    document.getElementById('slug').value = slug;
    updateCategorySlug();
});

// Kategori değiştiğinde slug önizlemesini güncelle
document.querySelector('[name="category_id"]').addEventListener('change', updateCategorySlug);

function updateCategorySlug() {
    const categorySelect = document.querySelector('[name="category_id"]');
    const categorySlugElement = document.getElementById('category-slug');
    
    if (categorySelect.value) {
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categoryName = selectedOption.text;
        const categorySlug = categoryName
            .toLowerCase()
            .replace(/ğ/g, 'g')
            .replace(/ü/g, 'u')
            .replace(/ş/g, 's')
            .replace(/ı/g, 'i')
            .replace(/ö/g, 'o')
            .replace(/ç/g, 'c')
            .replace(/[^a-z0-9]/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');
        
        categorySlugElement.textContent = categorySlug + '/';
    } else {
        categorySlugElement.textContent = '';
    }
}

// Kelime sayısı ve okuma süresi hesaplama
document.getElementById('content').addEventListener('input', function() {
    const content = this.value;
    const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
    const readTime = Math.max(1, Math.ceil(wordCount / 200)); // 200 kelime/dakika
    
    document.getElementById('word-count').textContent = `${wordCount} kelime`;
    document.getElementById('read-time').textContent = `${readTime} dk okuma`;
});

// AI Modal
document.getElementById('ai-help-btn').addEventListener('click', function() {
    document.getElementById('ai-modal').classList.remove('hidden');
});

document.getElementById('close-ai-modal').addEventListener('click', function() {
    document.getElementById('ai-modal').classList.add('hidden');
});

// Medya Modal
function openMediaModal() {
    document.getElementById('media-modal').classList.remove('hidden');
    loadMediaFiles();
}

document.getElementById('close-media-modal').addEventListener('click', function() {
    document.getElementById('media-modal').classList.add('hidden');
});

// Form submit işlemini yakala ve Jodit content'i senkronize et
function syncEditorContent() {
    if (window.joditEditor) {
        document.getElementById('content').value = window.joditEditor.getEditorValue();
    }
}

// Taslak kaydetme
async function saveDraft() {
    syncEditorContent();
    
    const form = document.querySelector('form');
    const formData = new FormData(form);
    formData.set('action', 'draft');
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            showNotification('Taslak kaydedildi!', 'success');
        }
    } catch (error) {
        showNotification('Taslak kaydedilemedi!', 'error');
    }
}

// Format text content for display
function formatTextContent(text) {
    if (!text) return '';
    
    // Check if content is already HTML
    const isHTML = /<[a-z][\s\S]*>/i.test(text);
    
    if (isHTML) {
        // Content is already HTML, return as is
        return text;
    } else {
        // Convert line breaks to HTML paragraphs for display
        return text
            .split('\n\n')
            .filter(paragraph => paragraph.trim())
            .map(paragraph => `<p class="mb-3">${paragraph.trim().replace(/\n/g, '<br>')}</p>`)
            .join('');
    }
}

// Convert plain text to proper HTML for WYSIWYG editor
function convertPlainTextToHTML(text) {
    if (!text) return '';
    
    // Split by double line breaks to get paragraphs
    const paragraphs = text.split('\n\n').filter(p => p.trim());
    
    let html = '';
    
    paragraphs.forEach(paragraph => {
        const trimmed = paragraph.trim();
        
        // Check if it's a title/heading (simple heuristics)
        if (trimmed.length < 100 && (
            trimmed.includes('Başlık') ||
            trimmed.includes('Giriş') ||
            trimmed.includes('Sonuç') ||
            trimmed.includes('Nedir') ||
            trimmed.includes('Nasıl') ||
            trimmed.includes('Ne') ||
            /^[A-ZÇĞIıÖŞÜ][^.]*[^.]$/.test(trimmed) // Starts with capital, no period at end
        )) {
            // Make it a heading
            html += `<h2>${trimmed}</h2>`;
        } else {
            // Regular paragraph - replace single line breaks with <br>
            const formattedText = trimmed.replace(/\n/g, '<br>');
            html += `<p>${formattedText}</p>`;
        }
    });
    
    return html;
}

// AI ile içerik oluşturma
async function generateWithAI(type) {
    const topic = document.getElementById('ai-topic').value;
    if (!topic.trim()) {
        alert('Lütfen bir konu girin!');
        return;
    }
    
    const length = document.getElementById('ai-length').value;
    const tone = document.getElementById('ai-tone').value;
    
    document.getElementById('ai-loading').classList.remove('hidden');
    document.getElementById('ai-result').classList.add('hidden');
    
    try {
        let response;
        
        if (type === 'seo') {
            // SEO için farklı endpoint ve parametreler
            const currentTitle = document.getElementById('title').value;
            const currentContent = window.joditEditor ? window.joditEditor.getEditorValue() : '';
            
            if (!currentTitle.trim()) {
                alert('SEO oluşturmak için önce başlık giriniz!');
                return;
            }
            
            const formData = new FormData();
            formData.append('title', currentTitle);
            formData.append('content', currentContent);
            
            response = await fetch('/admin/ai/generate-seo', {
                method: 'POST',
                body: formData
            });
        } else {
            // Normal içerik oluşturma
            const formData = new FormData();
            formData.append('topic', topic);
            formData.append('content_length', length);
            formData.append('content_type', tone);
            
            response = await fetch('/admin/ai/generate-content', {
                method: 'POST',
                body: formData
            });
        }
        
        const result = await response.json();
        
        if (result.success) {
            let content = '';
            if (result.data) {
                if (type === 'title') {
                    content = `<h3 class="font-semibold text-lg mb-2">Önerilen Başlık:</h3><p class="text-gray-700">${result.data.title || ''}</p>`;
                } else if (type === 'content') {
                    const formattedContent = formatTextContent(result.data.content || '');
                    content = `<h3 class="font-semibold text-lg mb-2">Önerilen İçerik:</h3><div class="text-gray-700">${formattedContent}</div>`;
                } else if (type === 'full') {
                    const formattedContent = formatTextContent(result.data.content || '');
                    content = `<h3 class="font-semibold text-lg mb-2">Önerilen Başlık:</h3><p class="text-gray-700 mb-4">${result.data.title || ''}</p>
                              <h3 class="font-semibold text-lg mb-2">Önerilen İçerik:</h3><div class="text-gray-700 mb-4">${formattedContent}</div>
                              <h3 class="font-semibold text-lg mb-2">Meta Açıklama:</h3><p class="text-gray-600 text-sm mb-4">${result.data.meta_description || ''}</p>
                              <h3 class="font-semibold text-lg mb-2">Etiketler:</h3><p class="text-gray-600 text-sm">${(result.data.tags || []).join(', ')}</p>`;
                } else if (type === 'seo') {
                    content = `<h3 class="font-semibold text-lg mb-2">Meta Açıklama:</h3><p class="text-gray-600 text-sm mb-4">${result.data.meta_description || ''}</p>
                              <h3 class="font-semibold text-lg mb-2">Etiketler:</h3><p class="text-gray-600 text-sm">${(result.data.tags || []).join(', ')}</p>`;
                }
            }
            document.getElementById('ai-content').innerHTML = content;
            document.getElementById('ai-result').classList.remove('hidden');
        } else {
            alert('AI içerik oluşturulamadı: ' + (result.error || 'Bilinmeyen hata'));
        }
    } catch (error) {
        console.error('AI generation error:', error);
        alert('AI servisi şu anda kullanılamıyor.');
    } finally {
        document.getElementById('ai-loading').classList.add('hidden');
    }
}

// AI önerisini uygula
function applyAISuggestion() {
    const aiContentDiv = document.getElementById('ai-content');
    const currentTitle = document.getElementById('title').value;
    
    // HTML içeriğinden veri çıkar - CSS selector kullanarak
    let title = '', content = '', metaDesc = '', tags = '';
    
    // Başlığı çıkar
    const titleElements = aiContentDiv.querySelectorAll('h3');
    for (let h3 of titleElements) {
        if (h3.textContent.includes('Önerilen Başlık:')) {
            const nextElement = h3.nextElementSibling;
            if (nextElement && nextElement.tagName === 'P') {
                title = nextElement.textContent.trim();
            }
        }
    }
    
    // İçeriği çıkar (HTML olarak)
    for (let h3 of titleElements) {
        if (h3.textContent.includes('Önerilen İçerik:')) {
            const nextElement = h3.nextElementSibling;
            if (nextElement && nextElement.tagName === 'DIV') {
                // Extract HTML content directly
                content = nextElement.innerHTML.trim();
            }
        }
    }
    
    // Meta açıklamayı çıkar
    for (let h3 of titleElements) {
        if (h3.textContent.includes('Meta Açıklama:')) {
            const nextElement = h3.nextElementSibling;
            if (nextElement && nextElement.tagName === 'P') {
                metaDesc = nextElement.textContent.trim();
            }
        }
    }
    
    // Etiketleri çıkar
    for (let h3 of titleElements) {
        if (h3.textContent.includes('Etiketler:')) {
            const nextElement = h3.nextElementSibling;
            if (nextElement && nextElement.tagName === 'P') {
                tags = nextElement.textContent.trim();
            }
        }
    }
    
    // Başlığı uygula
    if (title && !currentTitle) {
        document.getElementById('title').value = title;
        document.getElementById('title').dispatchEvent(new Event('input'));
    }
    
    // İçeriği uygula
    if (content && window.applyContentToEditor) {
        window.applyContentToEditor(content);
    }
    
    // Meta açıklamayı doldur
    if (metaDesc) {
        const metaDescField = document.getElementById('meta_description');
        if (metaDescField) {
            metaDescField.value = metaDesc;
        }
    }
    
    // Etiketleri doldur
    if (tags) {
        const tagsContainer = document.getElementById('tags-container');
        const tagsInput = document.getElementById('tags-input');
        if (tagsContainer && tagsInput && window.addTag) {
            // Mevcut etiketleri temizle
            const existingTags = tagsContainer.querySelectorAll('.tag-item');
            existingTags.forEach(tag => tag.remove());
            
            // Yeni etiketleri ekle
            const newTags = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            newTags.forEach(tagName => {
                addTag(tagName);
            });
        }
    }
    
    document.getElementById('ai-modal').classList.add('hidden');
    showNotification('AI önerisi uygulandı!', 'success');
}

// Medya dosyalarını yükle
async function loadMediaFiles() {
    try {
        const response = await fetch('/admin/media/api');
        const data = await response.json();
        
        const grid = document.getElementById('media-grid');
        grid.innerHTML = '';
        
        data.media.forEach(media => {
            const div = document.createElement('div');
            div.className = 'cursor-pointer rounded-lg overflow-hidden border border-cream-200 hover:border-brown-300 transition-smooth';
            div.onclick = () => selectMedia(media);
            
            if (media.mime_type.startsWith('image/')) {
                div.innerHTML = `<img src="${media.url}" alt="${media.alt_text}" class="w-full h-24 object-cover">`;
            } else {
                div.innerHTML = `<div class="w-full h-24 bg-gray-100 flex items-center justify-center"><i data-lucide="file" class="w-8 h-8 text-gray-400"></i></div>`;
            }
            
            grid.appendChild(div);
        });
        
        lucide.createIcons();
    } catch (error) {
        console.error('Medya yüklenemedi:', error);
    }
}

// Medya seçimi
function selectMedia(media) {
    // Kapak resmi olarak seç
    showFeaturedImagePreview(media.url);
    document.getElementById('featured-image-url').value = media.url;
    document.getElementById('media-modal').classList.add('hidden');
    showNotification('Kapak resmi seçildi!', 'success');
}

// Featured image upload
document.getElementById('featured-image-input').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert('Lütfen bir resim dosyası seçin!');
        return;
    }
    
    const formData = new FormData();
    formData.append('featured_image', file);
    
    try {
        showNotification('Resim yükleniyor ve optimize ediliyor...', 'info');
        
        const response = await fetch('/admin/posts/upload-featured-image', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showFeaturedImagePreview(result.url);
            document.getElementById('featured-image-url').value = result.url;
            
            const compression = ((result.original_size - result.optimized_size) / result.original_size * 100).toFixed(1);
            showNotification(`Resim yüklendi ve ${compression}% optimize edildi!`, 'success');
        } else {
            alert('Resim yüklenemedi: ' + result.error);
        }
    } catch (error) {
        console.error('Featured image upload error:', error);
        alert('Resim yüklenirken bir hata oluştu.');
    }
});

// Featured image preview gösterme
function showFeaturedImagePreview(url) {
    document.getElementById('featured-image-img').src = url;
    document.getElementById('featured-image-preview').classList.remove('hidden');
}

// Featured image kaldırma
function removeFeaturedImage() {
    document.getElementById('featured-image-preview').classList.add('hidden');
    document.getElementById('featured-image-url').value = '';
    document.getElementById('featured-image-input').value = '';
    showNotification('Kapak resmi kaldırıldı.', 'info');
}

// Bildirim gösterme
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 transition-smooth ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Jodit Editor ve diğer initialization
document.addEventListener('DOMContentLoaded', function() {
    // Sayfa yüklemesinde kategori slug'ı güncelle
    updateCategorySlug();
    
    // URL'den AI verilerini yükle (Editor'den önce)
    loadAIDataFromURL();
    
    // Jodit Editor'ü yükle
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/jodit@3.24.5/build/jodit.min.js';
    script.onload = function() {
        const contentTextarea = document.getElementById('content');
        if (contentTextarea) {
            const editor = Jodit.make(contentTextarea, {
                height: 450,
                theme: 'default',
                toolbar: true,
                spellcheck: true,
                language: 'tr',
                toolbarSticky: false,
                showCharsCounter: false,
                showWordsCounter: true,
                showXPathInStatusbar: false,
                askBeforePasteHTML: false,
                askBeforePasteFromWord: false,
                defaultActionOnPaste: 'insert_clear_html',
                enter: 'p',
                beautifyHTML: true,
                cleanHTML: {
                    fillEmptyParagraph: true,
                    replaceNBSP: true,
                    removeEmptyElements: false
                },
                buttons: [
                    'bold', 'italic', 'underline', 'strikethrough', '|',
                    'h1', 'h2', 'h3', 'h4', '|',
                    'superscript', 'subscript', '|',
                    'ul', 'ol', '|',
                    'outdent', 'indent', '|',
                    'font', 'fontsize', 'brush', 'paragraph', '|',
                    'image', 'file', 'video', 'table', 'link', '|',
                    'left', 'center', 'right', 'justify', '|',
                    'undo', 'redo', '|',
                    'hr', 'eraser', 'copyformat', '|',
                    'source', 'fullsize', 'print', 'about'
                ],
                uploader: {
                    insertImageAsBase64URI: false,
                    url: '/admin/media/upload',
                    filesVariableName: 'files',
                    withCredentials: false,
                    pathVariableName: 'path',
                    format: 'json',
                    method: 'POST',
                    prepareData: function (formData) {
                        return formData;
                    },
                    isSuccess: function (resp) {
                        return resp.success;
                    },
                    getMessage: function (resp) {
                        return resp.files && resp.files[0] ? resp.files[0].url : '';
                    },
                    process: function (resp) {
                        return {
                            files: resp.files || [],
                            path: '',
                            baseurl: '',
                            error: resp.error || 0,
                            msg: resp.message || ''
                        };
                    },
                    error: function (e) {
                        console.error('Upload error:', e);
                    }
                },
                filebrowser: {
                    ajax: {
                        url: '/admin/media/api'
                    },
                    height: 400
                }
            });
            
            // Kelime sayısı ve okuma süresini güncelle
            function updateWordCountAndReadTime() {
                const content = editor.getEditorValue();
                // HTML taglerini kaldır ve sadece metin içeriğini al
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                
                // Kelime sayısını hesapla (boşluk karakterleri ve satır sonlarını temizle)
                const cleanText = textContent.replace(/\s+/g, ' ').trim();
                const wordCount = cleanText ? cleanText.split(' ').filter(word => word.length > 0).length : 0;
                
                // Okuma süresini hesapla (dakika başına 200 kelime)
                const readTime = Math.max(1, Math.ceil(wordCount / 200));
                
                const wordCountElement = document.getElementById('word-count');
                const readTimeElement = document.getElementById('read-time');
                
                if (wordCountElement) {
                    wordCountElement.textContent = `${wordCount} kelime`;
                }
                if (readTimeElement) {
                    readTimeElement.textContent = `${readTime} dk okuma`;
                }
                
                console.log(`Kelime sayısı: ${wordCount}, Okuma süresi: ${readTime} dk`);
            }
            
            // Event listeners
            editor.events.on('change', updateWordCountAndReadTime);
            editor.events.on('afterInit', updateWordCountAndReadTime);
            
            // Periyodik güncelleme (kullanıcı hızlı yazarken)
            let updateTimeout;
            editor.events.on('keyup', function() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(updateWordCountAndReadTime, 500);
            });
            
            // Global referansı sakla
            window.joditEditor = editor;
            window.updateWordCount = updateWordCountAndReadTime;
            
            // AI önerisini editöre uygula
            window.applyContentToEditor = function(content) {
                // AI'dan gelen content zaten HTML formatında
                // Paragraflar arasında ve başlıklar sonrasında boşluk ekle
                let formattedContent = content
                    .replace(/<\/h([1-6])>/g, '</h$1>\n\n')  // Başlık sonrasına boşluk
                    .replace(/<\/p>/g, '</p>\n\n')            // Paragraf sonrasına boşluk
                    .replace(/<\/ul>/g, '</ul>\n\n')          // Liste sonrasına boşluk
                    .replace(/<\/ol>/g, '</ol>\n\n')          // Sıralı liste sonrasına boşluk
                    .replace(/\n\n+/g, '\n\n')               // Çoklu boşlukları tekle
                    .trim();                                  // Başta ve sonda boşluk temizle
                
                editor.setEditorValue(formattedContent);
                setTimeout(updateWordCountAndReadTime, 100);
            };
            
            // İlk yükleme sırasında mevcut içeriği kontrol et
            setTimeout(updateWordCountAndReadTime, 1000);
        }
    };
    document.head.appendChild(script);
});

// URL parametrelerinden AI verilerini yükle
function loadAIDataFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    console.log('Loading AI data from URL...', urlParams.toString());
    
    // AI title varsa
    const aiTitle = urlParams.get('ai_title');
    console.log('AI Title:', aiTitle);
    if (aiTitle) {
        const titleField = document.getElementById('title');
        if (titleField && !titleField.value.trim()) {
            titleField.value = decodeURIComponent(aiTitle);
            titleField.dispatchEvent(new Event('input')); // Slug'ı tetikle
            console.log('Title loaded:', titleField.value);
        }
    }
    
    // AI content varsa
    const aiContent = urlParams.get('ai_content');
    console.log('AI Content:', aiContent ? aiContent.substring(0, 100) + '...' : 'null');
    if (aiContent) {
        // Decode the content
        const decodedContent = decodeURIComponent(aiContent);
        console.log('Decoded content:', decodedContent.substring(0, 200) + '...');
        
        // Set the textarea value - Jodit Editor will pick this up when it initializes
        const contentTextarea = document.getElementById('content');
        if (contentTextarea && !contentTextarea.value.trim()) {
            // Convert to HTML format for better display
            const htmlContent = convertPlainTextToHTML(decodedContent);
            contentTextarea.value = htmlContent;
            console.log('Textarea HTML value set:', contentTextarea.value.length);
            
            // Trigger input event to notify any listeners
            contentTextarea.dispatchEvent(new Event('input'));
        }
    }
    
    // AI meta description varsa
    const aiMeta = urlParams.get('ai_meta');
    console.log('AI Meta:', aiMeta);
    if (aiMeta) {
        const metaField = document.querySelector('textarea[name="meta_description"]');
        if (metaField && !metaField.value.trim()) {
            metaField.value = decodeURIComponent(aiMeta);
            console.log('Meta loaded:', metaField.value);
        }
    }
    
    // AI tags varsa
    const aiTags = urlParams.get('ai_tags');
    console.log('AI Tags:', aiTags);
    if (aiTags) {
        const tagsField = document.getElementById('tags');
        if (tagsField && !tagsField.value.trim()) {
            tagsField.value = decodeURIComponent(aiTags);
            console.log('Tags loaded:', tagsField.value);
        }
    }
    
    // URL'yi temizle (parametreleri kaldır)
    if (aiTitle || aiContent || aiMeta || aiTags) {
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
}
</script>
{% endblock %}